x-ipfs: &ipfs-common
  build:
    context: .
    dockerfile: Dockerfile.ipfs
  restart: unless-stopped
  env_file: .env
  networks:
    - fabric-net
  healthcheck:
    test: ["CMD", "ipfs", "id"]
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 15s

services:
  ipfs-orderer:
    <<: *ipfs-common
    container_name: student-ledger-ipfs-orderer
    ports:
      - "127.0.0.1:5443:5443"
      - "127.0.0.1:4001:4001"
    volumes:
      - ./data/ipfs-orderer:/data/ipfs
      - ./swarm.key:/data/ipfs/swarm.key:ro

  ipfs-coordenacao:
    <<: *ipfs-common
    container_name: student-ledger-ipfs-coordenacao
    ports:
      - "127.0.0.1:5444:5443"
      - "127.0.0.1:4002:4001"
    volumes:
      - ./data/ipfs-coordenacao:/data/ipfs
      - ./swarm.key:/data/ipfs/swarm.key:ro
    depends_on:
      ipfs-orderer:
        condition: service_healthy

networks:
  fabric-net:
    external: true
